(function(){"use strict";const s=self;async function l(r,t,c){try{const n=await fetch(`https://www.googleapis.com/drive/v3/files/${r}?fields=size`,{headers:{Authorization:`Bearer ${c}`}});if(!n.ok)throw new Error(`Failed to get file size: ${n.statusText}`);const g=await n.json(),d=parseInt(g.size,10),e=new XMLHttpRequest;return e.open("GET",`https://www.googleapis.com/drive/v3/files/${r}?alt=media`),e.setRequestHeader("Authorization",`Bearer ${c}`),e.responseType="arraybuffer",e.onprogress=a=>{const p={type:"progress",fileId:r,loaded:a.loaded,total:d};s.postMessage(p)},e.onerror=()=>{const a={type:"error",fileId:r,error:"Network error during download"};s.postMessage(a)},e.ontimeout=()=>{const a={type:"error",fileId:r,error:"Download timed out"};s.postMessage(a)},e.onabort=()=>{const a={type:"error",fileId:r,error:"Download aborted"};s.postMessage(a)},new Promise((a,p)=>{e.onload=()=>{if(e.status>=200&&e.status<300)try{const o=e.response;console.log(`Worker: Download complete for ${t}`,{responseType:e.responseType,responseSize:o.byteLength,status:e.status});const i={type:"complete",fileId:r,fileName:t,data:o};console.log(`Worker: Sending complete message for ${t}`,{messageType:"complete",dataSize:o.byteLength}),s.postMessage(i,[o]),console.log(`Worker: Message posted for ${t}`),a()}catch(o){console.error("Worker: Error processing response:",o);const i={type:"error",fileId:r,error:`Error processing response: ${o.toString()}`};s.postMessage(i),p(o)}else{const o={type:"error",fileId:r,error:`HTTP error ${e.status}: ${e.statusText}`};s.postMessage(o),p(new Error(`HTTP error ${e.status}: ${e.statusText}`))}},e.send()})}catch(n){const g={type:"error",fileId:r,error:n.toString()};throw s.postMessage(g),n}}s.addEventListener("message",async r=>{console.log("Worker: Received message from main thread",r.data);try{const{fileId:t,fileName:c,accessToken:n}=r.data;console.log(`Worker: Starting download for ${c} (${t})`),await l(t,c,n),console.log(`Worker: Download function completed for ${c}`)}catch(t){console.error("Worker: Error in message handler:",t)}})})();
